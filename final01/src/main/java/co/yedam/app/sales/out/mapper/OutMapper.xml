<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="co.yedam.app.sales.out.mapper.OutMapper">
  <!-- 전체조회 -->
  	<select id="selectOutAllList" resultType="OutVO">
	SELECT o.sales_out_code sales_out_code
			, p.prod_name prod_name
			, a.act_name act_name
			, o.sales_out_amt sales_out_amt
			, o.sales_out_date sales_out_date
			, i.sales_in_exd sales_in_exd
	FROM sales_out o JOIN com_prod p
						ON (o.prod_code = p.prod_code)
						JOIN com_act a
						ON (o.act_code = a.act_code)
						JOIN sales_in i
						ON (o.prod_code = i.prod_code)
	ORDER BY sales_out_code DESC
  	</select>
  	
  	<!-- 거래처 목록 -->
	<select id="selectActAllList" resultType="OrderVO">
	SELECT act_code, act_name, act_sts, act_kind
	FROM com_act
	ORDER BY act_code DESC
	
	</select>
	<!-- 제품 목록 -->
	<select id="selectProdAllList" resultType="OrderVO">
	SELECT prod_code, prod_name, prod_unit, prod_std
	FROM com_prod
	WHERE prod_kind = 'C'
	ORDER BY prod_code DESC
	</select>
  	
  	<!-- 검색 -->
  <select id="selectAllOut" resultType="OutVO">
 SELECT o.sales_out_code sales_out_code
			, p.prod_name prod_name
			, a.act_name act_name
			, o.sales_out_amt sales_out_amt
			, o.sales_out_date sales_out_date
			, i.sales_in_exd sales_in_exd
	FROM sales_out o JOIN com_prod p
						ON (o.prod_code = p.prod_code)
						JOIN com_act a
						ON (o.act_code = a.act_code)
						JOIN sales_in i
						ON (o.prod_code = i.prod_code)
	<where>
			<if test="actCode != null and actCode != ''">
				AND a.act_code LIKE '%' || #{actCode} || '%'
			</if>
			<if test="prodCode != null and prodCode != ''">
				AND p.prod_code LIKE '%' || #{prodCode} || '%'
			</if>
			<if test="startDate != null and startDate != ''">
            	AND o.sales_out_date <![CDATA[>=]]> TO_DATE(#{startDate}, 'YYYY-MM-DD')
         	</if>
         	<if test="endDate != null and endDate != ''">
           		AND o.sales_out_date <![CDATA[<=]]> TO_DATE(#{endDate}, 'YYYY-MM-DD')
         	</if>
	</where>					
	ORDER BY sales_out_code DESC
	</select>
	
	<!-- 출고완료된 품목만 보여주는 출고 리스트 -->
	<select id="selectOutNList" resultType="OutVO">
	SELECT o.sales_out_code sales_out_code
			, p.prod_name prod_name
			, a.act_name act_name
			, o.sales_out_amt sales_out_amt
			, o.sales_out_date sales_out_date
			, i.sales_in_exd sales_in_exd
	FROM sales_out o JOIN com_prod p
						ON (o.prod_code = p.prod_code)
						JOIN com_act a
						ON (o.act_code = a.act_code)
						JOIN sales_in i
						ON (o.prod_code = i.prod_code)
						JOIN sales_ord_de d
						ON (o.sales_ord_de_code = d.sales_ord_de_code)
	WHERE d.dev_yn = 'N'
	ORDER BY sales_out_code DESC
  	</select>
	
	
	<!-- 출고 등록 -->
	<insert id="insertOutList" parameterType="OutVO">
		<selectKey keyProperty="salesOutCode" resultType="String" order="BEFORE">
			SELECT 'OUT-' || TO_CHAR(sysdate, 'rrMMdd') || LPAD(NVL(MAX(SUBSTR(sales_out_code, -3)),0) + 1, 3, '0')
			FROM sales_out
			WHERE SUBSTR(sales_out_code, 5, 6) = TO_CHAR(sysdate, 'rrMMdd')
		</selectKey>
			INSERT 	INTO sales_out
			(
			sales_out_code
			, prod_code
			, act_code
			, sales_out_date
			, sales_out_amt
			, emp_code
			, sales_ord_de_code
			, prod_lot
			)
			VALUES
			(
			#{salesOutCode}
			, #{prodCode}
			, #{actCode}
			, #{salesOutDate}
			, #{salesOutAmt}
			, #{empCode}
			, #{salesOrdDeCode}
			, #{prodLot}
			)
			<!-- 두번째 쿼리 -->
	</insert>
	
  </mapper>