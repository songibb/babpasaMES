<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="co.yedam.app.sales.order.mapper.OrderMapper">
  <!-- 전체조회 -->
  <select id="selectOrderAllList" resultType="OrderVO">
	SELECT d.sales_ord_de_code sales_ord_de_code
			, o.ord_date ord_date
			, a.act_name act_name
			, o.ord_sts ord_sts
			, p.prod_name prod_name
			, d.prcs_rq_amt prcs_rq_amt
			, d.dev_date dev_date
			, d.dev_yn dev_yn
	FROM sales_ord o JOIN sales_ord_de d
						ON (o.ord_code = d.ord_code)
						JOIN com_prod p
						ON (d.prod_code = p.prod_code)
						JOIN com_act a
						ON (o.act_code = a.act_code)
	ORDER BY o.ord_code DESC
  </select>
  
  <!-- 검색 -->
  <select id="selectAllOrder" resultType="OrderVO">
  SELECT d.sales_ord_de_code sales_ord_de_code
			, o.ord_date ord_date
			, a.act_name act_name
			, o.ord_sts ord_sts
			, p.prod_name prod_name
			, d.prcs_rq_amt prcs_rq_amt
			, d.dev_date dev_date
			, d.dev_yn dev_yn
	FROM sales_ord o JOIN sales_ord_de d
						ON (o.ord_code = d.ord_code)
						JOIN com_prod p
						ON (d.prod_code = p.prod_code)
						JOIN com_act a
						ON (o.act_code = a.act_code)
	<where>
			<if test="actCode != null and actCode != ''">
				AND a.act_code LIKE '%' || #{actCode} || '%'
			</if>
			<if test="prodCode != null and prodCode != ''">
				AND p.prod_code LIKE '%' || #{prodCode} || '%'
			</if>
<!-- 			<if test="ordDate != null and ordDate != ''"> -->
<!-- 				AND o.ord_date <![CDATA[>=]]> TO_DATE(#{ordDate}, 'YYYY-MM-DD') -->
<!-- 			</if> -->
			<if test="startDate != null and startDate != ''">
            	AND o.ord_date <![CDATA[>=]]> TO_DATE(#{startDate}, 'YYYY-MM-DD')
         	</if>
         	<if test="endDate != null and endDate != ''">
           		AND o.ord_date <![CDATA[<=]]> TO_DATE(#{endDate}, 'YYYY-MM-DD')
         	</if>
	</where>					
	ORDER BY o.ord_code DESC
	</select>
	<!-- 거래처 목록 -->
	<select id="selectActAllList" resultType="OrderVO">
	SELECT act_code, act_name, act_sts, act_kind
	FROM com_act
	ORDER BY act_code
	
	</select>
	<!-- 제품 목록 -->
	<select id="selectProdAllList" resultType="OrderVO">
	SELECT prod_code, prod_name, prod_unit, prod_std
	FROM com_prod
	WHERE prod_kind = 'C'
	ORDER BY prod_code
	</select>
	
	<!-- 주문서 등록 -->
	<insert id="insertOrderList" parameterType="OrderVO">
		<selectKey keyProperty="ordCode" resultType="String" order="BEFORE">
			SELECT 'ORD-' || TO_CHAR(sysdate, 'rrMMdd') || LPAD(NVL(MAX(SUBSTR(mat_od_cd, -3)),0) + 1, 3, '0')
			FROM sales_ord
			WHERE SUBSTR(ord_code, 5, 6) = TO_CHAR(sysdate, 'rrMMdd')
		</selectKey>
		BEGIN
			<!-- 첫번째 쿼리 -->
			INSERT 	INTO
				sales_ord
			VALUES(
				#{ordCode}
				,#{orderList[0].ordDate}
				,#{orderList[0].actCode}
				,#{orderList[0].empCode}
				,#{orderList[0].ordSts}
				,#{orderList[0].prcsPlanCode}
			);
			<!-- 두번째 쿼리 -->
			<foreach collection="orderList" item="order" index="index" open="" separator=" " close="">
			INSERT INTO 
				sales_ord_de(sales_ord_de_code,
								ord_code,
								prod_code,
								prcs_rq_amt,
								dev_date,
								dev_yn
								)
            VALUES
            
                (get_primaryCode(''), 
                 #{ordCode}, 
                 #{order.prodCode}, 
                 #{order.prcsRqAmt}, 
                 #{order.devDate}, 
                 'N');
            </foreach>
            
		END;
	</insert>
	
	<!-- 주문서 관리 - 미계획 주문서 목록 -->
	<select id="selectAllNoPlanList" resultType="OrderVO">
		SELECT d.sales_ord_de_code, d.ord_code, p.prod_name, d.prcs_rq_amt, d.dev_date, o.ord_sts
		FROM sales_ord_de d JOIN com_prod p
                    ON (d.prod_code = p.prod_code)
                    JOIN sales_ord o
                    ON (d.ord_code = o.ord_code)
		WHERE o.ord_sts = 'p1'
		ORDER BY d.dev_date
	</select>
  </mapper>